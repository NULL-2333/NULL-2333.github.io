<!DOCTYPE html>
<html  lang="en" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>Objective-C与Runtime | Yiming</title>
    <meta name="description" content="什么是Runtime Runtime的普遍定义 引用Wiki的定义：  In computer science, runtime, run time, or execution time is the final phase of a computer program’s life cycle, in which the code is being executed on the computer">
<meta property="og:type" content="article">
<meta property="og:title" content="Objective-C与Runtime">
<meta property="og:url" content="http://yoursite.com/Objective-C%E4%B8%8ERuntime/">
<meta property="og:site_name" content="Yiming">
<meta property="og:description" content="什么是Runtime Runtime的普遍定义 引用Wiki的定义：  In computer science, runtime, run time, or execution time is the final phase of a computer program’s life cycle, in which the code is being executed on the computer">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/OC&amp;runtime-20200921004704111.png">
<meta property="og:image" content="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/XCode.png">
<meta property="og:image" content="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/metaClass-20200921005347532.png">
<meta property="og:image" content="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/image-20200910001142554.png">
<meta property="article:published_time" content="2020-07-19T03:21:42.000Z">
<meta property="article:modified_time" content="2020-09-20T16:53:54.028Z">
<meta property="article:author" content="Yiming">
<meta property="article:tag" content="Objective-C">
<meta property="article:tag" content="Runtime">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/OC&amp;runtime-20200921004704111.png">

    
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
<meta name="generator" content="Hexo 4.2.1"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://null-2333.github.io" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_self" rel="noopener" rel="noreferrer" >
                <img src="/images/head1.jpeg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block" style="font-size: 24px; font-weight: 600; padding-bottom: 10px">Yiming</h2>
            <h3 id="title" class="hidden xl:block">Coding for fun ~</h3>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" style="padding-left: 5px" placeholder="Search" class="inline-block w-full bg-gray-100 lg:bg-white">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="Search" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-5 pb-3 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            <hr />
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">Home</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">Archives</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">Tags</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-repository" role="menuitem">
                <a href="/repository">
                    <i class="iconfont icon-project" aria-hidden="true"></i>
                    <span class="menu-title">Repository</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-links" role="menuitem">
                <a href="/links">
                    <i class="iconfont icon-friend" aria-hidden="true"></i>
                    <span class="menu-title">Links</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a href="https://github.com/NULL-2333" target="_blank" rel="noopener">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-12 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            Objective-C与Runtime
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/Objective-C%E4%B8%8ERuntime/" class="article-date">
	  <time datetime="2020-07-19T03:21:42.000Z" itemprop="datePublished">Jul 19</time>
	</a>
</span>

                

                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-link" href="/tags/Objective-C/" rel="tag">Objective-C</a>, <a class="article-tag-link" href="/tags/Runtime/" rel="tag">Runtime</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/Objective-C%E4%B8%8ERuntime/#comments" class="article-comment-link">
                        Comments
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">Word Count: 2.3k(words)</span>
    
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="什么是Runtime">什么是Runtime</h2>
<h3 id="Runtime的普遍定义">Runtime的普遍定义</h3>
<p>引用Wiki的定义：</p>
<blockquote>
<p>In computer science, runtime, run time, or execution time is the final phase of a computer program’s life cycle, in which the code is being executed on the computer’s central processing unit (CPU) as machine code.</p>
</blockquote>
<p>也就是说，Runtime就是程序经过编译之后在CPU上运行的状态。Runtime Library就是程序处于Runtime的时候所能引用的库，Runtime Error就是程序在运行时所得到的错误，常见的有除数为零错误、作用域错误、数组溢出错误等。</p>
<h3 id="Objective-C中的Runtime">Objective-C中的Runtime</h3>
<p>C语言中，在编译过程中，编译器就会确定所要调用的函数的位置；</p>
<p>而OC中的函数是动态的，在编译过程中并不能确定要调用函数的位置，因此就需要通过Runtime来动态地创建类和对象以及传递和转发消息。</p>
<p><img src="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/OC&amp;runtime-20200921004704111.png" alt="OC&amp;runtime.png"></p>
<p>OC可以通过三种方式和Runtime进行交互：</p>
<ol>
<li>
<p>OC源码</p>
</li>
<li>
<p>FoundationKit中NSObject协议和类中的如下方法</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; @protocol NSObject</span><br><span class="line">- (Class)class OBJC_SWIFT_UNAVAILABLE(&quot;use &#39;type(of: anObject)&#39; instead&quot;);</span><br><span class="line">- (BOOL)isKindOfClass:(Class)aClass;</span><br><span class="line">- (BOOL)isMemberOfClass:(Class)aClass;</span><br><span class="line">- (BOOL)conformsToProtocol:(Protocol *)aProtocol;</span><br><span class="line">- (BOOL)respondsToSelector:(SEL)aSelector;</span><br><span class="line">&#x2F;&#x2F; @interface NSObject</span><br><span class="line">&#x2F;&#x2F; 返回制定方法的实现的地址</span><br><span class="line">- (IMP)methodForSelector:(SEL)aSelector;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>对Runtime库的直接调用，主要是&lt;objc/Runtime.h&gt;和&lt;objc/message.h&gt;两个头文件的引入</li>
</ol>
<p>P.S. 如果需要打开Runtime库的代码提示，需要设置如下位置为NO</p>
<p><img src="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/XCode.png" alt="XCode"></p>
<h2 id="Runtime的用法">Runtime的用法</h2>
<h3 id="通过消息转发实现多继承">通过消息转发实现多继承</h3>
<p><img src="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/metaClass-20200921005347532.png" alt="metaClass.png"></p>
<h4 id="消息转发机制">消息转发机制</h4>
<p><img src="https://raw.githubusercontent.com/NULL-2333/blog-comment/master/2020/09/image-20200910001142554.png" alt="image-20200910001142554"></p>
<p>p.s. 此处要通过转发的方式调用函数，就不能通过类似[myObject testFunc]或者[MyObject testFunc]的方式直接调用，这样在编译的时候就会报错，而是需要用如下方式调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[MyObject performSelector:@selector(testFunc1)]; &#x2F;&#x2F; 类方法</span><br><span class="line">[myObject performSelector:@selector(testFunc2)]; &#x2F;&#x2F; 对象方法</span><br></pre></td></tr></table></figure>
<h4 id="类方法的转发">类方法的转发</h4>
<p>设当前类为MyObject，要调用的类方法为testFunc，即</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[MyObject performSelector:@selector(testFunc)];</span><br></pre></td></tr></table></figure>
<ol>
<li>
<p>首先会去MyObject这个类中找testFunc这个方法，如果有则直接返回对应的SEL即可；</p>
</li>
<li>
<p>重写+ (BOOL)resolveClassMethod:(SEL)sel方法，该方法返回YES则说明可以为MyObject这个类动态添加一个类方法testFunc，例如：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;resolveClassMethod, %@&quot;, NSStringFromSelector(sel));</span><br><span class="line">  if (sel &#x3D;&#x3D; @selector(testFunc:Name:)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果要在这一步转发，则应当使用class_addMethod</span><br><span class="line">    &#x2F;&#x2F; return class_addMethod(objc_getMetaClass(&quot;MyObject&quot;), sel, (IMP)testFunc, &quot;v@:&quot;);</span><br><span class="line">    return NO;</span><br><span class="line">  &#125;</span><br><span class="line">  return [super resolveClassMethod:sel];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意此处的函数class_addMethod的参数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class_addMethod(Class _Nullable cls, SEL _Nonnull name, IMP _Nonnull imp, const char * _Nullable types)</span><br></pre></td></tr></table></figure>
<p>第一个参数cls表示当前对象所属的类，由于这是类方法，因此cls应当为当前类的Meta Class；</p>
<p>第二个参数name为当前转发的选择器；</p>
<p>第三个参数imp为要转发到的方法的实现，该方法必须要有两个默认的参数(id self,SEL _cmd)（这两个参数对于每一个NSObject子类中的方法都是已经隐含了的）；</p>
<p>第四个参数types为返回类型和方法的参数类型的编码，具体可见<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="noopener">Type Encodings</a></p>
<ol start="3">
<li>重写+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector方法，返回对应selector的signature，示例如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSMethodSignature* signature &#x3D; [super methodSignatureForSelector:aSelector];</span><br><span class="line">  if (!signature) &#123;</span><br><span class="line">    signature &#x3D; [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">  &#125;</span><br><span class="line">  return signature;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>重写+ (void)forwardInvocation:(NSInvocation *)anInvocation进行最后一步转发，此处可以随意转发到任意类的类方法，示例如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+ (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">  if ([MyObject respondsToSelector:@selector(sing)]) &#123;</span><br><span class="line">    [anInvocation setSelector:@selector(sing)];</span><br><span class="line">    &#x2F;&#x2F; 注意此处target依然需要为class对象</span><br><span class="line">    [anInvocation invokeWithTarget:[MyObject class]];</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    [super forwardInvocation:anInvocation];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>重写+ (void)doesNotRecognizeSelector:(SEL)aSelector方法，此方法会在找不到对应的selector的最后调用，其super方法会抛出异常，一般不建议覆盖该方法。</li>
</ol>
<details><summary>Code</summary>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit&#x2F;UIKit.h&gt;</span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &lt;objc&#x2F;objc.h&gt;</span><br><span class="line">#import &lt;objc&#x2F;runtime.h&gt;</span><br><span class="line">#import &lt;objc&#x2F;message.h&gt;</span><br><span class="line">@interface OtherObject : NSObject</span><br><span class="line">+ (void)speak;</span><br><span class="line">@end</span><br><span class="line">@implementation OtherObject</span><br><span class="line">+ (void)speak &#123;</span><br><span class="line">  NSLog(@&quot;Speak!!!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@interface MyObject : NSObject</span><br><span class="line">@end</span><br><span class="line">@implementation MyObject</span><br><span class="line">+ (void) sing</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;Sing&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;resolveClassMethod, %@&quot;, NSStringFromSelector(sel));</span><br><span class="line">  if (sel &#x3D;&#x3D; @selector(testFunc:Name:)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果要在这一步转发，则应当使用class_addMethod</span><br><span class="line">    &#x2F;&#x2F; return class_addMethod(objc_getMetaClass(&quot;MyObject&quot;), sel, (IMP)testFunc, &quot;v@:&quot;);</span><br><span class="line">    return NO;</span><br><span class="line">  &#125;</span><br><span class="line">  return [super resolveClassMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;forwardingTargetForSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">  &#x2F;&#x2F; 如果要在这一步使用OtherObject的类方法（同名）去相应</span><br><span class="line">  &#x2F;&#x2F; if([NSStringFromSelector(aSelector) isEqualToString:@&quot;testFunc:Name:&quot;])&#123;</span><br><span class="line">  &#x2F;&#x2F;   return [OtherObject class];</span><br><span class="line">  &#x2F;&#x2F; &#125;</span><br><span class="line">  return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;methodSignatureForSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">  NSMethodSignature* signature &#x3D; [super methodSignatureForSelector:aSelector];</span><br><span class="line">  if (!signature) &#123;</span><br><span class="line">    signature &#x3D; [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">  &#125;</span><br><span class="line">  return signature;</span><br><span class="line">&#125;</span><br><span class="line">+ (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;   if ([OtherObject respondsToSelector:@selector(speak)]) &#123;</span><br><span class="line">&#x2F;&#x2F;     NSLog(@&quot;forwardInvocation YES, %@&quot;, anInvocation.target);</span><br><span class="line">&#x2F;&#x2F;     [anInvocation setSelector:@selector(speak)];</span><br><span class="line">&#x2F;&#x2F;     [anInvocation invokeWithTarget:[OtherObject class]];</span><br><span class="line">&#x2F;&#x2F;   &#125;   </span><br><span class="line">  if ([MyObject respondsToSelector:@selector(sing)]) &#123;</span><br><span class="line">    NSLog(@&quot;forwardInvocation YES, %@&quot;, anInvocation.target);</span><br><span class="line">    [anInvocation setSelector:@selector(sing)];</span><br><span class="line">    [anInvocation invokeWithTarget:[MyObject class]];</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    NSLog(@&quot;forwardInvocation NO&quot;);</span><br><span class="line">    [super forwardInvocation:anInvocation];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">+ (void)doesNotRecognizeSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;doesNotRecognizeSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@interface ViewController ()</span><br><span class="line">@end</span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">  [super viewDidLoad];</span><br><span class="line">  self.title &#x3D; @&quot;RUNTIME&quot;;</span><br><span class="line">  [MyObject performSelector:@selector(testFunc:Name:)];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
</details>
<h4 id="对象方法的转发">对象方法的转发</h4>
<p>对象方法的转发所涉及的函数和类方法基本类似，只不过都从类方法变成了对象方法（除了resolveClassMethod变成resolveInstanceMethod）</p>
<details><summary>Code</summary>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;UIKit&#x2F;UIKit.h&gt;</span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &lt;objc&#x2F;objc.h&gt;</span><br><span class="line">#import &lt;objc&#x2F;runtime.h&gt;</span><br><span class="line">#import &lt;objc&#x2F;message.h&gt;</span><br><span class="line">@interface OtherObject : NSObject</span><br><span class="line">- (void)speak;</span><br><span class="line">@end</span><br><span class="line">@implementation OtherObject</span><br><span class="line">- (void)speak &#123;</span><br><span class="line">  NSLog(@&quot;Speak!!!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@interface MyObject : NSObject</span><br><span class="line">@end</span><br><span class="line">@implementation MyObject</span><br><span class="line">- (void) sing</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;Sing&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveInstanceMethod:(SEL)sel</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;resolveInstanceMethod, %@&quot;, NSStringFromSelector(sel));</span><br><span class="line">  if (sel &#x3D;&#x3D; @selector(testFunc:Name:)) &#123;</span><br><span class="line">    &#x2F;&#x2F; 如果要在这一步转发，则应当使用class_addMethod</span><br><span class="line">    &#x2F;&#x2F; return class_addMethod([self class], sel, (IMP)testFunc, &quot;v@:&quot;);</span><br><span class="line">    return NO;</span><br><span class="line">  &#125;</span><br><span class="line">  return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;forwardingTargetForSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">  &#x2F;&#x2F; 如果要在这一步使用OtherObject的对象方法（同名）去相应</span><br><span class="line">  &#x2F;&#x2F; if([NSStringFromSelector(aSelector) isEqualToString:@&quot;testFunc:Name:&quot;])&#123;</span><br><span class="line">  &#x2F;&#x2F;   return [[OtherObject alloc] init];</span><br><span class="line">  &#x2F;&#x2F; &#125;</span><br><span class="line">  return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;methodSignatureForSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">  NSMethodSignature* signature &#x3D; [super methodSignatureForSelector:aSelector];</span><br><span class="line">  if (!signature) &#123;</span><br><span class="line">    signature &#x3D; [NSMethodSignature signatureWithObjCTypes:&quot;v@:&quot;];</span><br><span class="line">  &#125;</span><br><span class="line">  return signature;</span><br><span class="line">&#125;</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;   OtherObject *otherObject &#x3D; [[OtherObject alloc] init];</span><br><span class="line">&#x2F;&#x2F;   if ([otherObject respondsToSelector:@selector(speak)]) &#123;</span><br><span class="line">&#x2F;&#x2F;     NSLog(@&quot;forwardInvocation YES, %@&quot;, anInvocation.target);</span><br><span class="line">&#x2F;&#x2F;     [anInvocation setSelector:@selector(speak)];</span><br><span class="line">&#x2F;&#x2F;     [anInvocation invokeWithTarget:otherObject];</span><br><span class="line">&#x2F;&#x2F;   &#125;</span><br><span class="line">  if ([self respondsToSelector:@selector(sing)]) &#123;</span><br><span class="line">    NSLog(@&quot;forwardInvocation YES, %@&quot;, anInvocation.target);</span><br><span class="line">    [anInvocation setSelector:@selector(sing)];</span><br><span class="line">    [anInvocation invokeWithTarget:self];</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    NSLog(@&quot;forwardInvocation NO&quot;);</span><br><span class="line">    [super forwardInvocation:anInvocation];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)doesNotRecognizeSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  NSLog(@&quot;doesNotRecognizeSelector, %@&quot;, NSStringFromSelector(aSelector));</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@interface ViewController ()</span><br><span class="line">@end</span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">  [super viewDidLoad];</span><br><span class="line">  self.title &#x3D; @&quot;RUNTIME&quot;;</span><br><span class="line">  MyObject *myObject &#x3D; [[MyObject alloc] init];</span><br><span class="line">  [myObject performSelector:@selector(testFunc:Name:)];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
</details>
<h4 id="通过消息转发实现的多继承">通过消息转发实现的多继承</h4>
<p>假设在forwardingTargetForSelector这一步就将MyObject的testFunc: Name: 转发给OtherObject，则:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MyObject *myObject &#x3D; [[MyObject alloc] init];</span><br><span class="line">[myObject performSelector:@selector(testFunc:Name:) withObject:@(12) withObject:@&quot;Test&quot;];</span><br></pre></td></tr></table></figure>
<p>上述代码中myObject实际上执行的是OtherObject中的testFunc: Name: 方法。我们可以修改如下函数的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  return [[OtherObject alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">  return [OtherObject class];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样在调用MyObject的类方法和对象方法的时候，如果在MyObject类中已经有该方法的实现，则会直接调用该方法的实现；如果没有，则会去OtherObject中寻找该方法的实现。这种模式和MyObject继承自OtherObject是一样的，因此相当于可以用消息转发来实现继承的操作，进而可以实现多继承。</p>
<p>但是这种方法和真正的继承还是不一样的，区别在于调用isKindOfClass函数的时候，真正的继承是可以判断出子类是父类的kindClass，但是消息转发实现的则不能。</p>
<h3 id="Method-Swizzling">Method Swizzling</h3>
<p>这是一种OC hook机制的实现</p>
<h3 id="关联对象">关联对象</h3>
<p>用法举例说明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (AssociateObject)</span><br><span class="line"> </span><br><span class="line">@property (nonatomic, strong) NSString *associatedObject;</span><br><span class="line">@end</span><br><span class="line">@implementation NSObject (AssociateObject)</span><br><span class="line">@dynamic associatedObject;</span><br><span class="line">- (void) setAssociatedObject:(id)associatedObject</span><br><span class="line">&#123;</span><br><span class="line">  objc_setAssociatedObject(self, @selector(associatedObject), associatedObject, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *) associatedObject</span><br><span class="line">&#123;</span><br><span class="line">  return objc_getAssociatedObject(self, @selector(associatedObject));</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>涉及到的函数</p>
<ol>
<li>设置关联对象</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_setAssociatedObject(id _Nonnull object, const void * _Nonnull key, id _Nullable value, objc_AssociationPolicy policy);</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>获取关联对象</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT id _Nullable objc_getAssociatedObject(id _Nonnull object, const void * _Nonnull key);</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>移除关联对象</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OBJC_EXPORT void objc_removeAssociatedObjects(id _Nonnull object);</span><br></pre></td></tr></table></figure>
<p>这三个函数中object对应于该关联对象的实例对象，key是用于区分不同的关联对象，可以使用字符串，或者@selector(associatedObject)作为key，value则是关联对象，policy对应的是关联对象的存取策略，与property的attributes一一对应，如下表：</p>
<table>
<thead>
<tr>
<th>Policy</th>
<th>@property</th>
</tr>
</thead>
<tbody>
<tr>
<td>OBJC_ASSOCIATION_ASSIGN</td>
<td>@property(assign) / @property(unsafe_unretained)</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td>
<td>@property(nonatomic, strong)</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_COPY_NONATOMIC</td>
<td>@property(nonatomic, copy)</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_RETAIN</td>
<td>@property(atomic, strong)</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_COPY</td>
<td>@property(atomic, copy)</td>
</tr>
</tbody>
</table>
<p>P.S. 这里的remove函数是移除所有的关联对象，因此如果要单独删去某一个的话只要用set函数将其置为nil即可。</p>
<h3 id="快速Encode和Decode">快速Encode和Decode</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)initWithCoder:(NSCoder *)coder</span><br><span class="line">&#123;</span><br><span class="line">  self &#x3D; [super init];</span><br><span class="line">  if (self) &#123;</span><br><span class="line">    unsigned int cnt &#x3D; 0;</span><br><span class="line">    Ivar *vars &#x3D; class_copyIvarList([self class], &amp;cnt);</span><br><span class="line">    for(int i &#x3D; 0; i &lt; cnt; i++)&#123;</span><br><span class="line">      NSString *key &#x3D; [NSString stringWithUTF8String:ivar_getName(vars[i])];</span><br><span class="line">      id value &#x3D; [coder decodeObjectForKey:key];</span><br><span class="line">      [self setValue:value forKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)encodeWithCoder:(nonnull NSCoder *)coder &#123;</span><br><span class="line">  unsigned int cnt &#x3D; 0;</span><br><span class="line">  Ivar *vars &#x3D; class_copyIvarList([self class], &amp;cnt);</span><br><span class="line">  for(int i &#x3D; 0; i &lt; cnt; i++)&#123;</span><br><span class="line">    NSString *key &#x3D; [NSString stringWithUTF8String:ivar_getName(vars[i])];</span><br><span class="line">    id value &#x3D; [self valueForKey:key];</span><br><span class="line">    [coder encodeObject:value forKey:key];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tips，现在的类在遵循NSCoding的同时还需要遵循NSSecureCoding，且使用这两个协议的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">NSData *data &#x3D; [NSKeyedArchiver archivedDataWithRootObject:stu </span><br><span class="line">                requiringSecureCoding:YES </span><br><span class="line">                error:nil];</span><br><span class="line">Student *stu2 &#x3D; [NSKeyedUnarchiver unarchivedObjectOfClasses:</span><br><span class="line">          [NSSet setWithObjects:[Student class], </span><br><span class="line">                      [NSMutableArray class], </span><br><span class="line">                      [NSMutableDictionary class], nil] </span><br><span class="line">                  fromData:data </span><br><span class="line">                  error:nil];</span><br><span class="line">&#x2F;&#x2F; 切记存在非常规类型的时候需要用unarchivedObjectofClasses这个方法并定义好NSSet类型的classes</span><br></pre></td></tr></table></figure>

        </div>
        

    </article>
    
    <section id="comments">
        
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a></noscript>
            </div>
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">Catalogue</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是Runtime"><span class="toc-number">1.</span> <span class="toc-text">什么是Runtime</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Runtime的普遍定义"><span class="toc-number">1.1.</span> <span class="toc-text">Runtime的普遍定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Objective-C中的Runtime"><span class="toc-number">1.2.</span> <span class="toc-text">Objective-C中的Runtime</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Runtime的用法"><span class="toc-number">2.</span> <span class="toc-text">Runtime的用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过消息转发实现多继承"><span class="toc-number">2.1.</span> <span class="toc-text">通过消息转发实现多继承</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#消息转发机制"><span class="toc-number">2.1.1.</span> <span class="toc-text">消息转发机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#类方法的转发"><span class="toc-number">2.1.2.</span> <span class="toc-text">类方法的转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#对象方法的转发"><span class="toc-number">2.1.3.</span> <span class="toc-text">对象方法的转发</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#通过消息转发实现的多继承"><span class="toc-number">2.1.4.</span> <span class="toc-text">通过消息转发实现的多继承</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Method-Swizzling"><span class="toc-number">2.2.</span> <span class="toc-text">Method Swizzling</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#关联对象"><span class="toc-number">2.3.</span> <span class="toc-text">关联对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快速Encode和Decode"><span class="toc-number">2.4.</span> <span class="toc-text">快速Encode和Decode</span></a></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a href="https://github.com/NULL-2333" target="_blank" rel="noopener">
                <i class="iconfont icon-github"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>

<script src="//cdn.jsdelivr.net/npm/yox@1.0.0-alpha.121/dist/standard/prod/yox.min.js"></script>


<script src="/js/search.min.js"></script>


    <script defer>
    var disqus_config = function () {
        
            this.page.url = 'http://yoursite.com/Objective-C%E4%B8%8ERuntime/';
        
        this.page.identifier = 'Objective-C与Runtime';
    };
    (function() {
        var d = document, s = d.createElement('script');
        s.src = '//' + '' + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>





    </body>
</html>
